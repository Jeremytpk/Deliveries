<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon DSP Directory</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7f9fb;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px #0001;
            padding: 32px 40px 40px 40px;
        }
        h1 {
            font-size: 2.2em;
            margin-bottom: 0.5em;
            color: #2a3a4b;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5em;
            margin-bottom: 1.5em;
        }
        .controls input[type="text"] {
            padding: 0.6em 1em;
            border: 1px solid #bfcad6;
            border-radius: 6px;
            font-size: 1em;
            width: 280px;
            background: #f7f9fb;
        }
        .filters label {
            margin-right: 1em;
            font-size: 0.98em;
            color: #2a3a4b;
        }
        .filters input[type="checkbox"] {
            accent-color: #4F8A8B;
        }
        #summary {
            font-weight: 500;
            color: #4F8A8B;
            margin-bottom: 1.2em;
        }
        #download-btn {
            background: #4F8A8B;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.7em 1.5em;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 8px #0001;
            transition: background 0.2s;
        }
        #download-btn:hover {
            background: #357a7b;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px #0002;
            margin-bottom: 1.5em;
        }
        th, td {
            border: none;
            padding: 14px 18px;
            text-align: left;
            font-size: 1.08em;
        }
        th {
            background: linear-gradient(90deg, #eaf3fa 0%, #f4f8fb 100%);
            color: #2a3a4b;
            font-weight: 700;
            letter-spacing: 0.03em;
        }
        tbody tr {
            transition: background 0.2s;
        }
        tbody tr:nth-child(even) {
            background: #f7f9fb;
        }
        tbody tr:hover {
            background: #e3e8ee;
        }
        #download-modal {
            display:none;
            position:fixed;
            top:0; left:0; right:0; bottom:0;
            background:rgba(44,62,80,0.18);
            z-index:1000;
        }
        #download-modal .modal-box {
            position:absolute;
            top:50%; left:50%; transform:translate(-50%,-50%);
            background:#fff;
            border-radius:10px;
            box-shadow:0 4px 24px #0002;
            padding:2em 2.5em;
            min-width:320px;
            text-align:center;
        }
        #download-modal button {
            margin: 1em 0.5em 0 0.5em;
            padding: 0.6em 1.2em;
            border-radius: 6px;
            border: none;
            font-size: 1em;
            background: #4F8A8B;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        #download-modal button:hover {
            background: #357a7b;
        }
        #debug-console {
            background:#222;color:#eee;padding:1em;margin-top:2em;max-height:200px;overflow:auto;border-radius:8px;
        }
    </style>
</head>
<body>
    <!-- Top-right pagination container -->
    <div style="display:flex; justify-content:flex-end; margin-bottom:1em;">
        <div id="pagination-top"></div>
    </div>
    <div class="container">
    <h1>Company Directory</h1>
        <div class="controls">
            <input type="text" id="search-input" placeholder="Search...">
            <div class="filters">
                <span style="margin-right:1em;">Filter by:</span>
                <label><input type="checkbox" class="filter-check" value="Name" checked> Company Name</label>
                <label><input type="checkbox" class="filter-check" value="Type" checked> Type</label>
                <label><input type="checkbox" class="filter-check" value="City" checked> City</label>
                <label><input type="checkbox" class="filter-check" value="State/Province" checked> State</label>
                <label><input type="checkbox" class="filter-check" value="Zip/Postal Code" checked> Zip</label>
                <label><input type="checkbox" class="filter-check" value="Country" checked> Country</label>
                <label><input type="checkbox" class="filter-check" value="Region" checked> Region</label>
                <label><input type="checkbox" class="filter-check" value="Owner" checked> Owner</label>
            </div>
            <button id="download-btn">Download CSV/Excel</button>
        </div>
    <div id="summary"></div>
    
    <div id="table-container">Loading data...</div>
        <!-- Bottom pagination container -->
        <div style="margin-top:1em; display:flex; justify-content:center;">
            <div id="pagination-bottom"></div>
        </div>
        <div id="download-modal">
            <div class="modal-box">
                <div id="modal-content" style="margin-bottom:1em;"></div>
                <button id="modal-csv">Download CSV</button>
                <button id="modal-xlsx">Download Excel</button>
                <button id="modal-cancel">Cancel</button>
            </div>
        </div>
        <pre id="debug-console">Debug console:</pre>
    </div>
    <script>
    function showDownloadModal(count) {
        document.getElementById('modal-content').textContent = `Download current page with ${count} DSPs?`;
        document.getElementById('download-modal').style.display = 'block';
    }

    function hideDownloadModal() {
        document.getElementById('download-modal').style.display = 'none';
    }

    function tableToCSV(rows, headers) {
        const csvRows = [headers.join(',')];
        rows.forEach(row => {
            csvRows.push(headers.map(h => '"' + (row[h] || '').replace(/"/g, '""') + '"').join(','));
        });
        return csvRows.join('\n');
    }

    function downloadCSV(rows, headers) {
        const csv = tableToCSV(rows, headers);
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dsp_directory.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function downloadExcel(rows, headers) {
        // Simple Excel XML format
        let xml = '<?xml version="1.0"?>\n';
        xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
        xml += '<Worksheet ss:Name="DSPs"><Table>';
        xml += '<Row>' + headers.map(h => `<Cell><Data ss:Type="String">${h}</Data></Cell>`).join('') + '</Row>';
        rows.forEach(row => {
            xml += '<Row>' + headers.map(h => `<Cell><Data ss:Type="String">${(row[h] || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</Data></Cell>`).join('') + '</Row>';
        });
        xml += '</Table></Worksheet></Workbook>';
        const blob = new Blob([xml], {type: 'application/vnd.ms-excel'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dsp_directory.xls';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    document.getElementById('download-btn').addEventListener('click', function() {
        // Get currently displayed rows
        const value = document.getElementById('search-input').value.toLowerCase();
        const filters = getActiveFilters();
        const filtered = dspRows.filter(row => {
            return filters.some(f => (row[f] || '').toLowerCase().includes(value));
        });
        showDownloadModal(filtered.length);
        // Store for modal actions
        window._filteredRows = filtered;
    });

    document.getElementById('modal-csv').addEventListener('click', function() {
        downloadCSV(window._filteredRows, dspHeaders);
        hideDownloadModal();
    });
    document.getElementById('modal-xlsx').addEventListener('click', function() {
        downloadExcel(window._filteredRows, dspHeaders);
        hideDownloadModal();
    });
    document.getElementById('modal-cancel').addEventListener('click', hideDownloadModal);
    let dspRows = [];
    let dspHeaders = [];
    let currentPage = 1;
    const pageSize = 100;

    function renderTable(filteredRows) {



        // Tableau style: all columns
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');
        dspHeaders.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        // Pagination logic
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = Math.min(startIdx + pageSize, filteredRows.length);
        const pageRows = filteredRows.slice(startIdx, endIdx);
        pageRows.forEach(row => {
            const tr = document.createElement('tr');
            dspHeaders.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header] || '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        const container = document.getElementById('table-container');
        if (container) {
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Show company names above the table
        const companyNamesDiv = document.getElementById('company-names');
        if (companyNamesDiv) {
            const names = filteredRows.map(r => r['Name']).filter(Boolean);
            companyNamesDiv.innerHTML = names.length ? `<strong>Companies:</strong> ${names.join(', ')}` : '';
        }

        // Summary stats
        const summaryDiv = document.getElementById('summary');
        if (summaryDiv) {
            const companyCount = filteredRows.length;
            const countrySet = new Set(filteredRows.map(r => r['Country']).filter(Boolean));
            const stateSet = new Set(filteredRows.map(r => r['State/Province']).filter(Boolean));
            summaryDiv.textContent = `Companies: ${companyCount} | Countries: ${countrySet.size} | States: ${stateSet.size}`;
        }

        // Pagination controls (top right and bottom)
        const totalPages = Math.ceil(filteredRows.length / pageSize);
        let html = '';
        if (totalPages > 1) {
            html += `<button ${currentPage === 1 ? 'disabled' : ''} id="prev-page">&lt; Prev</button>`;
            html += ` Page ${currentPage} of ${totalPages} `;
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} id="next-page">Next &gt;</button>`;
        }
        // Top right
        const paginationTop = document.getElementById('pagination-top');
        if (paginationTop) paginationTop.innerHTML = html;
        // Bottom
        const paginationBottom = document.getElementById('pagination-bottom');
        if (paginationBottom) paginationBottom.innerHTML = html;
        if (totalPages > 1) {
            // Add event listeners for both paginations
            document.querySelectorAll('#prev-page').forEach(btn => {
                btn.onclick = function() {
                    if (currentPage > 1) { currentPage--; renderTable(filteredRows); }
                };
            });
            document.querySelectorAll('#next-page').forEach(btn => {
                btn.onclick = function() {
                    if (currentPage < totalPages) { currentPage++; renderTable(filteredRows); }
                };
            });
        }
    }

    async function loadDSPData() {
    // Fetch merged DSPs and FedEx ISPs from backend
    const url = 'http://127.0.0.1:5001/api/all-companies';
        try {
            const response = await fetch(url);
            if (!response.ok) {
                document.getElementById('table-container').textContent = 'Failed to load data.';
                document.getElementById('debug-console').textContent += `\nError: ${response.status} ${response.statusText}`;
                return;
            }
            const data = await response.json();
            dspHeaders = data.headers;
            dspRows = data.rows;
            renderTable(dspRows);
        } catch (err) {
            document.getElementById('table-container').textContent = 'Failed to load data.';
            document.getElementById('debug-console').textContent += `\nException: ${err}`;
        }
    }

    function getActiveFilters() {
        return Array.from(document.querySelectorAll('.filter-check:checked')).map(cb => cb.value);
    }

    function filterRows() {
        const value = document.getElementById('search-input').value.toLowerCase();
        const filters = getActiveFilters();
        const filtered = dspRows.filter(row => {
            return filters.some(f => (row[f] || '').toLowerCase().includes(value));
        });
        currentPage = 1;
        renderTable(filtered);
    }

    document.getElementById('search-input').addEventListener('input', filterRows);
    document.querySelectorAll('.filter-check').forEach(cb => {
        cb.addEventListener('change', filterRows);
    });

    loadDSPData();
    </script>
</body>
</html>
